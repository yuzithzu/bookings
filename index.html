<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>📦 Booking App — Full</title>

  <!-- SheetJS (Excel) -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <!-- html2canvas (JPEG export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* ---------- General ---------- */
    :root {
      --main: #0d6efd;
      --accent: #0d6efd;
      --danger: #dc3545;
      --muted: #6c757d;
    }
    * { box-sizing: border-box; font-family: "Poppins", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    body { margin: 0; background: #f4f6f9; color: #222; min-height: 100vh; display: flex; }

    /* ---------- Sidebar ---------- */
    .sidebar {
      width: 230px; background: var(--main); color: #fff; padding: 22px 16px; display:flex; flex-direction:column; align-items:center;
    }
    .sidebar h2 { margin: 0 0 18px; font-size:18px; }
    .nav-item { width:100%; text-align:center; padding:10px 6px; cursor:pointer; border-radius:8px; margin-bottom:6px; }
    .nav-item.active, .nav-item:hover { background: rgba(255,255,255,0.12); }

    /* ---------- Main ---------- */
    .main { flex:1; padding:18px; overflow:auto; }
    .container { max-width:1100px; margin: 0 auto; }
    h1 { color:var(--main); text-align:center; margin-bottom:12px; }

    form.card {
      background:#fff; border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(15,15,15,0.06);
      margin-bottom:18px;
    }
    label { display:block; font-weight:600; margin-top:10px; }
    input[type="text"], input[type="tel"], input[type="number"], input[type="date"], input[type="time"],
    select, textarea {
      width:100%; padding:8px 10px; margin-top:6px; border-radius:8px; border:1px solid #d0d7de; font-size:14px;
    }
    textarea { resize: vertical; min-height:60px; }

    .flex-row { display:flex; gap:10px; align-items:center; }
    .flex-row > * { flex:1; }

    .btn {
      display:inline-block; background:var(--accent); color:#fff; padding:9px 12px; border-radius:8px; border:none; cursor:pointer;
      font-weight:600; margin-top:12px;
    }
    .btn.secondary { background:#6c757d; }
    .btn.danger { background:var(--danger); }

    /* ---------- Table (items) ---------- */
    .table-responsive { overflow-x:auto; margin-top:10px; }
    table { width:100%; border-collapse:collapse; min-width:900px; table-layout:fixed; }
    th, td { border:1px solid #e6e9ee; padding:8px; font-size:13px; vertical-align:top; text-align:center; }
    th { background:var(--main); color:#fff; font-weight:700; }
    td input, td select { width:100%; padding:6px; box-sizing:border-box; }

    /* wrap remarks column */
    td.remarksCol, th.remarksCol { max-width:220px; word-wrap:break-word; white-space:normal; overflow-wrap:break-word; text-align:left; }

    .small { padding:6px 8px; font-size:13px; }

    /* record list */
    .summary { background:#fff; padding:14px; border-radius:10px; box-shadow:0 6px 18px rgba(15,15,15,0.04); }
    .record { border:1px solid #e6e9ee; padding:10px; border-radius:8px; margin-bottom:10px; background:#fafbff; }
    .record h4 { margin:0 0 6px; color:var(--main); }
    .record p { margin:4px 0; color:#333; font-size:14px; }

    /* responsive */
    @media (max-width:900px) {
      .sidebar { display:none; }
      table { min-width:720px; }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>📦 Booking App</h2>
    <div class="nav-item active">New Booking</div>
    <div class="nav-item">Records</div>
  </div>

  <div class="main">
    <div class="container">
      <h1>Booking Form</h1>

      <!-- FORM -->
      <form id="bookingForm" class="card">
        <div style="display:flex; gap:12px; align-items:flex-start;">
          <div style="flex:1;">
            <label for="name">Name of Account (MD/Patient):</label>
            <input id="name" type="text" required>

            <label for="contact">Contact Number:</label>
            <input id="contact" type="tel" required>

            <label for="delivery">Delivery Option:</label>
            <select id="delivery">
              <option>Pick-Up (by client at office)</option>
              <option>Delivery (by MANILA branch rider to hub (CSP)</option>
              <option selected>Pick-Up by Lalamove / Grab / Courier</option>
            </select>

            <label for="address">Pick-Up / Delivery Address:</label>
            <textarea id="address" rows="2"></textarea>

            <div class="flex-row">
              <div>
                <label for="date">Preferred Date</label>
                <input id="date" type="date">
              </div>
              <div>
                <label for="time">Preferred Time</label>
                <input id="time" type="time">
              </div>
            </div>

            <label for="payment">Payment Option:</label>
            <select id="payment">
              <option value="C.O.D">C.O.D (Cash on Delivery)</option>
              <option value="Terms">Terms</option>
              <option value="PDC">PDC (Post Dated Check)</option>
              <option value="Bank">Deposited thru Bank</option>
            </select>

            <div id="termsDaysContainer" style="display:none;">
              <label for="termsDays">Terms (Days):</label>
              <input id="termsDays" type="number" min="1" placeholder="Enter number of days">
            </div>

            <div id="bankContainer" style="display:none;">
              <label for="bankName">Bank Name:</label>
              <input id="bankName" type="text" placeholder="e.g. BPI, BDO, Metrobank">
            </div>
          </div>

          <div style="width:320px;">
            <label for="distributor">Distributor & Branch:</label>
            <input id="distributor" type="text">

            <label for="remarks">Remarks / Special Instructions:</label>
            <textarea id="remarks" rows="6" placeholder="Notes for rider, special handling, etc."></textarea>

            <label for="total">Total Amount (₱):</label>
            <input id="total" type="number" readonly step="0.01">

            <button id="saveBooking" class="btn" style="width:100%;">Save Booking</button>
          </div>
        </div>

        <!-- Items table -->
        <label style="margin-top:14px;">Order Details:</label>
        <div class="table-responsive">
          <table id="orderTable" aria-label="Order items">
            <thead>
              <tr>
                <th style="width:110px">Generic</th>
                <th style="width:110px">Brand</th>
                <th style="width:110px">Qty</th>
                <th style="width:100px">Unit</th>
                <th style="width:110px">SRP</th>
                <th style="width:120px">Discount Type</th>
                <th style="width:120px">Discount Value</th>
                <th style="width:120px">Discount Amt</th>
                <th style="width:120px">No Discount</th>
                <th style="width:120px">Remarks</th>
                <th style="width:110px">Total</th>
                <th style="width:60px">🗑</th>
              </tr>
            </thead>
            <tbody id="orderBody"></tbody>
          </table>
        </div>

        <div style="display:flex; gap:10px; margin-top:10px;">
          <button type="button" id="addRow" class="btn secondary" style="background:#198754">+ Add Item</button>
          <button type="button" id="clearItems" class="btn secondary" style="background:#6c757d">Clear Items</button>
        </div>
      </form>

      <!-- SUMMARY / RECORDS -->
      <div class="summary">
        <h3 style="margin-top:0;">Saved Bookings</h3>
        <div id="recordList"></div>
      </div>
    </div>
  </div>

  <script>
  /* -------------------- Elements -------------------- */
  const nameInput = document.getElementById('name');
  const contactInput = document.getElementById('contact');
  const deliveryInput = document.getElementById('delivery');
  const addressInput = document.getElementById('address');
  const dateInput = document.getElementById('date');
  const timeInput = document.getElementById('time');
  const paymentSelect = document.getElementById('payment');
  const termsDaysContainer = document.getElementById('termsDaysContainer');
  const termsDaysInput = document.getElementById('termsDays');
  const bankContainer = document.getElementById('bankContainer');
  const bankNameInput = document.getElementById('bankName');
  const distributorInput = document.getElementById('distributor');
  const remarksInput = document.getElementById('remarks');
  const totalField = document.getElementById('total');

  const addRowBtn = document.getElementById('addRow');
  const clearItemsBtn = document.getElementById('clearItems');
  const orderBody = document.getElementById('orderBody');

  const saveBookingBtn = document.getElementById('saveBooking');
  const recordList = document.getElementById('recordList');

  /* -------------------- Payment toggle -------------------- */
  paymentSelect.addEventListener('change', () => {
    const val = paymentSelect.value;
    termsDaysContainer.style.display = (val === 'Terms') ? 'block' : 'none';
    bankContainer.style.display = (val === 'Bank') ? 'block' : 'none';
  });

  /* -------------------- Add one default row -------------------- */
  addRow(); // create one empty row on load

  /* -------------------- Functions: addRow, updateTotals -------------------- */
  function addRow() {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" class="generic" placeholder="Generic name"></td>
      <td><input type="text" class="brand" placeholder="Brand"></td>
      <td><input type="number" class="qty" min="0" step="0.01" value="1" style="width:100%;"></td>
      <td>
        <select class="unit">
          <option value="pcs">Pcs</option>
          <option value="box">Box</option>
          <option value="pfs">Pfs</option>
          <option value="vial">Vial</option>
        </select>
      </td>
      <td><input type="number" class="srp" min="0" step="0.01" value="0"></td>
      <td>
        <select class="discountType">
          <option value="percent">%</option>
          <option value="amount">Fixed Amount</option>
          <option value="nodisc">No Discount</option>
        </select>
      </td>
      <td><input type="number" class="discount" min="0" step="0.01" value="0"></td>
      <td><input type="number" class="discountAmt" readonly></td>
      <td><input type="number" class="nodisc" readonly></td>
      <td class="remarksCol"><input type="text" class="remarksItem" placeholder="Remarks"></td>
      <td><input type="number" class="total" readonly></td>
      <td><button type="button" class="btn-danger small deleteRow" style="background:#dc3545; color:#fff; border-radius:6px; padding:6px 8px;">❌</button></td>
    `;
    orderBody.appendChild(tr);
    // attach event listeners for inputs in this row dynamically
    tr.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', updateTotals);
      el.addEventListener('change', updateTotals);
    });
    // delete row handler
    tr.querySelector('.deleteRow').addEventListener('click', () => {
      tr.remove();
      updateTotals();
    });
    updateTotals();
  }

  clearItemsBtn.addEventListener('click', () => {
    orderBody.innerHTML = '';
    addRow(); updateTotals();
  });

  function updateTotals() {
    let grand = 0;
    const rows = orderBody.querySelectorAll('tr');
    rows.forEach(row => {
      const qty = parseFloat(row.querySelector('.qty').value) || 0;
      const srp = parseFloat(row.querySelector('.srp').value) || 0;
      const discType = row.querySelector('.discountType').value;
      const discVal = parseFloat(row.querySelector('.discount').value) || 0;
      const noDisc = qty * srp;
      let discAmt = 0;
      if (discType === 'percent') discAmt = noDisc * (discVal / 100);
      else if (discType === 'amount') discAmt = discVal;
      const total = Math.max(0, noDisc - discAmt);
      row.querySelector('.discountAmt').value = discAmt.toFixed(2);
      row.querySelector('.nodisc').value = noDisc.toFixed(2);
      row.querySelector('.total').value = total.toFixed(2);
      grand += total;
    });
    totalField.value = grand.toFixed(2);
  }

  addRowBtn.addEventListener('click', addRow);

  /* -------------------- Save booking -------------------- */
  saveBookingBtn.addEventListener('click', (e) => {
    e.preventDefault();

    // gather items
    const items = [];
    orderBody.querySelectorAll('tr').forEach(row => {
      items.push({
        generic: row.querySelector('.generic').value || '',
        brand: row.querySelector('.brand').value || '',
        qty: row.querySelector('.qty').value || 0,
        unit: row.querySelector('.unit').value || '',
        srp: row.querySelector('.srp').value || 0,
        discountType: row.querySelector('.discountType').value || '',
        discount: row.querySelector('.discount').value || 0,
        discountAmt: row.querySelector('.discountAmt').value || 0,
        total: row.querySelector('.total').value || 0,
        remarks: row.querySelector('.remarksItem').value || ''
      });
    });

    const paymentType = (paymentSelect.value === 'Terms') ? `Terms (${termsDaysInput.value || '0'} days)` :
                        (paymentSelect.value === 'Bank') ? `Bank - ${bankNameInput.value || ''}` :
                        paymentSelect.value;

    // timestamp
    const createdAt = new Date().toLocaleString();

    const record = {
      name: nameInput.value || '',
      contact: contactInput.value || '',
      delivery: deliveryInput.value || '',
      address: addressInput.value || '',
      date: dateInput.value || '',
      time: timeInput.value || '',
      payment: paymentType,
      distributor: distributorInput.value || '',
      remarks: remarksInput.value || '',
      total: totalField.value || '0.00',
      items: items,
      createdAt: createdAt
    };

    // save to localStorage
    const records = JSON.parse(localStorage.getItem('bookings')) || [];
    records.push(record);
    localStorage.setItem('bookings', JSON.stringify(records));

    // reset form (but don't lose theme etc.)
    document.getElementById('bookingForm').reset();
    orderBody.innerHTML = '';
    addRow(); updateTotals();
    totalField.value = '';

    // reload list
    loadRecords();
    // focus name for quick input
    nameInput.focus();
  });

  /* -------------------- Load records to UI -------------------- */
  function loadRecords() {
    const records = JSON.parse(localStorage.getItem('bookings')) || [];
    recordList.innerHTML = '';
    if (records.length === 0) {
      recordList.innerHTML = '<p style="color:var(--muted);">No bookings yet.</p>';
      return;
    }

    records.forEach((rec, idx) => {
      const div = document.createElement('div');
      div.className = 'record';
      div.innerHTML = `
        <h4>${escapeHtml(rec.name)} - ₱${rec.total}</h4>
        <p>📞 ${escapeHtml(rec.contact)}<br>
           🚚 ${escapeHtml(rec.delivery)}<br>
           💳 ${escapeHtml(rec.payment)}<br>
           🏢 ${escapeHtml(rec.distributor)}<br>
           📍 ${escapeHtml(rec.address || 'N/A')}<br>
           🕒 Created: ${escapeHtml(rec.createdAt || 'N/A')}</p>
        <p><b>Remarks:</b> ${escapeHtml(rec.remarks || 'None')}</p>

        <div style="margin-top:8px;">
          <button class="btn" onclick="downloadExcel(${idx})">📄 Export Excel</button>
          <button class="btn" onclick="downloadJPEG(${idx})">🖼 View/Download JPEG</button>
          <button class="btn danger" style="background:var(--danger)" onclick="deleteRecord(${idx})">🗑 Delete</button>
        </div>

        <details style="margin-top:10px;">
          <summary style="cursor:pointer;">View Items (${rec.items.length})</summary>
          <div style="overflow:auto; margin-top:8px;">
            <table>
              <thead>
                <tr>
                  <th>Generic</th><th>Brand</th><th>Qty</th><th>Unit</th><th>SRP</th><th>Disc Type</th><th>Disc Val</th><th>Disc Amt</th><th>Total</th><th>Remarks</th>
                </tr>
              </thead>
              <tbody>
                ${rec.items.map(item => `
                  <tr>
                    <td>${escapeHtml(item.generic)}</td>
                    <td>${escapeHtml(item.brand)}</td>
                    <td>${escapeHtml(item.qty)}</td>
                    <td>${escapeHtml(item.unit)}</td>
                    <td>${escapeHtml(item.srp)}</td>
                    <td>${escapeHtml(item.discountType)}</td>
                    <td>${escapeHtml(item.discount)}</td>
                    <td>${escapeHtml(item.discountAmt)}</td>
                    <td>${escapeHtml(item.total)}</td>
                    <td>${escapeHtml(item.remarks)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </details>
      `;
      recordList.appendChild(div);
    });
  }

  /* -------------------- Delete record -------------------- */
  function deleteRecord(index) {
    const records = JSON.parse(localStorage.getItem('bookings')) || [];
    if (!records[index]) return;
    if (!confirm('Delete this booking?')) return;
    records.splice(index, 1);
    localStorage.setItem('bookings', JSON.stringify(records));
    loadRecords();
  }
  window.deleteRecord = deleteRecord; // expose to inline onclick

  /* -------------------- Export Excel -------------------- */
  function downloadExcel(index) {
    const records = JSON.parse(localStorage.getItem('bookings')) || [];
    const rec = records[index];
    if (!rec) return alert('Record not found.');

    // Prepare worksheet data
    const wsData = [
      ['Booking for', rec.name],
      ['Contact', rec.contact],
      ['Delivery', rec.delivery],
      ['Address', rec.address || 'N/A'],
      ['Preferred Date & Time', `${rec.date} ${rec.time}`],
      ['Payment', rec.payment],
      ['Distributor', rec.distributor],
      ['Remarks', rec.remarks || 'None'],
      ['Created At', rec.createdAt || 'N/A'],
      [],
      ['Generic','Brand','Qty','Unit','SRP','Discount Type','Discount Value','Discount Amt','Total','Remarks']
    ];

    rec.items.forEach(item => {
      wsData.push([
        item.generic, item.brand, item.qty, item.unit, item.srp,
        item.discountType, item.discount, item.discountAmt, item.total, item.remarks
      ]);
    });

    wsData.push(['','','','','','','','','Total Amount', rec.total]);

    // workbook & worksheet
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // auto column width
    const headerRowIndex = 10;
    const colWidths = wsData[headerRowIndex].map((_, i) => {
      const max = Math.max(...wsData.map(r => (r[i] ? String(r[i]).length : 0)));
      return { wch: Math.min(Math.max(max + 2, 10), 40) };
    });
    ws['!cols'] = colWidths;

    XLSX.utils.book_append_sheet(wb, ws, 'Booking');
    const safeName = (rec.name || 'Booking').replace(/[\\/:*?"<>|]/g, '_');
    const filename = `Booking_${safeName}_${(rec.date || '')}.xlsx`;
    XLSX.writeFile(wb, filename);
  }
  window.downloadExcel = downloadExcel;

  /* -------------------- Export JPEG (cross-browser) -------------------- */
  function downloadJPEG(index) {
    const records = JSON.parse(localStorage.getItem('bookings')) || [];
    const rec = records[index];
    if (!rec) return alert('Record not found.');

    // build temporary printable container
    const tmp = document.createElement('div');
    tmp.style.padding = '20px';
    tmp.style.background = '#fff';
    tmp.style.width = '1000px';
    tmp.style.fontFamily = 'Poppins, sans-serif';
    tmp.style.color = '#222';
    tmp.style.fontSize = '13px';

    // build html of summary + items
    tmp.innerHTML = `
      <h2 style="color:${getComputedStyle(document.documentElement).getPropertyValue('--main') || '#0d6efd'}; text-align:center; margin:0 0 12px;">📦 Booking Summary</h2>
      <p><b>Booking for:</b> ${escapeHtml(rec.name)}</p>
      <p><b>Contact:</b> ${escapeHtml(rec.contact)}</p>
      <p><b>Delivery:</b> ${escapeHtml(rec.delivery)}</p>
      <p><b>Address:</b> ${escapeHtml(rec.address || 'N/A')}</p>
      <p><b>Preferred Date & Time:</b> ${escapeHtml(rec.date)} ${escapeHtml(rec.time)}</p>
      <p><b>Payment:</b> ${escapeHtml(rec.payment)}</p>
      <p><b>Distributor:</b> ${escapeHtml(rec.distributor)}</p>
      <p><b>Remarks / Special Instructions:</b> ${escapeHtml(rec.remarks || 'None')}</p>
      <p><b>Created At:</b> ${escapeHtml(rec.createdAt || 'N/A')}</p>
      <br>
      <table border="1" cellspacing="0" cellpadding="6" style="width:100%; border-collapse:collapse; text-align:center; table-layout:fixed;">
        <thead style="background:${getComputedStyle(document.documentElement).getPropertyValue('--main') || '#0d6efd'}; color:#fff;">
          <tr>
            <th>Generic</th><th>Brand</th><th>Qty</th><th>Unit</th><th>SRP</th><th>Disc Type</th><th>Disc Val</th><th>Disc Amt</th><th>Total</th><th>Remarks</th>
          </tr>
        </thead>
        <tbody>
          ${rec.items.map(it => `
            <tr>
              <td>${escapeHtml(it.generic)}</td>
              <td>${escapeHtml(it.brand)}</td>
              <td>${escapeHtml(it.qty)}</td>
              <td>${escapeHtml(it.unit)}</td>
              <td>${escapeHtml(it.srp)}</td>
              <td>${escapeHtml(it.discountType)}</td>
              <td>${escapeHtml(it.discount)}</td>
              <td>${escapeHtml(it.discountAmt)}</td>
              <td>${escapeHtml(it.total)}</td>
              <td style="white-space:normal; word-wrap:break-word; max-width:200px; text-align:left;">${escapeHtml(it.remarks)}</td>
            </tr>
          `).join('')}
          <tr>
            <td colspan="8" style="text-align:right; font-weight:bold;">Total Amount</td>
            <td colspan="2" style="font-weight:bold;">₱${escapeHtml(rec.total)}</td>
          </tr>
        </tbody>
      </table>
    `;

    // append to DOM, convert to canvas
    document.body.appendChild(tmp);
    html2canvas(tmp, { scale: 3, backgroundColor: '#ffffff', useCORS: true }).then(canvas => {
      const dataURL = canvas.toDataURL('image/jpeg', 1.0);
      const safeName = (rec.name || 'Booking').replace(/[\\/:*?"<>|]/g, '_');
      const filename = `Booking_${safeName}_${(rec.date || '')}.jpeg`;

      // detect platform
      const ua = navigator.userAgent.toLowerCase();
      const isIOS = /iphone|ipad|ipod/.test(ua);
      const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

      if (isIOS && isSafari) {
        // open in new tab for viewing (Safari blocks automatic download)
        const newTab = window.open();
        if (newTab) {
          newTab.document.write(`<title>${escapeHtml(filename)}</title>`);
          newTab.document.write('<img src="' + dataURL + '" style="max-width:100%;">');
        } else {
          // fallback: prompt user to long-press
          alert('Safari blocked opening a new tab. You can still long-press the image to save it.');
        }
      } else {
        // attempt download (works on Android / Desktop)
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      // remove temp
      document.body.removeChild(tmp);
    }).catch(err => {
      document.body.removeChild(tmp);
      alert('Image export failed: ' + (err.message || err));
      console.error(err);
    });
  }
  window.downloadJPEG = downloadJPEG;

  /* -------------------- helpers -------------------- */
  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  /* -------------------- initial load -------------------- */
  loadRecords();
  </script>
</body>
</html>
