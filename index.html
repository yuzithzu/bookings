<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üì¶ Booking App</title>
<style>
/* CSS Reset and General Styling */
* { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
body { margin: 0; display: flex; height: 100vh; background: #f4f6f9; }

/* Variables for Theming */
:root {
    --sidebar-color: #0d6efd;
    --main-color: #0d6efd;
    --btn-color: #0d6efd;
}

/* Sidebar Styles */
.sidebar {
  width: 230px; background: var(--sidebar-color); color: white;
  display: flex; flex-direction: column; align-items: center; padding: 20px 0;
}
.sidebar h2 { font-size: 20px; margin-bottom: 40px; }
.nav-item { width: 100%; text-align: center; padding: 12px 0; cursor: pointer; transition: 0.2s; }
.nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.15); }

/* Main Content Styles */
.main { flex: 1; padding: 30px; overflow-y: auto; }
h1 { color: var(--main-color); text-align: center; margin-bottom: 20px; }
form {
  background: #fff; padding: 20px; border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 900px; margin: auto;
}

/* Form Element Styles */
label { font-weight: 600; margin-top: 10px; display: block; }
input, textarea, select {
  width: 100%; padding: 8px; margin-top: 6px;
  border: 1px solid #ccc; border-radius: 8px; font-size: 14px;
}
input:focus, textarea:focus, select:focus { border-color: var(--main-color); outline: none; }
.btn {
  width: 100%; background: var(--btn-color); color: white; border: none;
  border-radius: 8px; padding: 10px; font-size: 16px; cursor: pointer;
  margin-top: 15px; transition: 0.2s;
}
.btn:hover { opacity: 0.9; }

/* Table Styles */
.table-responsive { overflow-x: auto; width: 100%; }
.table-responsive table { width: 100%; min-width: 800px; border-collapse: collapse; }
table, th, td { border: 1px solid #ddd; padding: 6px; font-size: 13px; text-align: center; }
th { background: var(--main-color); color: white; }

/* Summary/Record Styles */
.summary-container {
  background: #fff; padding: 15px; border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  margin-top: 20px; max-height: 400px; overflow-y: auto;
}
.record {
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 10px 12px;
  margin-bottom: 12px;
  background: #fafbff;
}
.record h4 { margin: 0 0 5px; color: var(--main-color); }
.record table th, .record table td {
  border: 1px solid #ddd; font-size: 12px; padding: 4px; text-align: center;
}
.delete-btn { background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; }
.delete-btn:hover { background: #b02a37; }

/* Media Queries for Responsiveness */
@media (max-width: 768px) {
  body { flex-direction: column; height: auto; }
  .sidebar { width: 100%; flex-direction: row; justify-content: space-around; padding: 10px 0; }
  .sidebar h2 { font-size: 18px; margin: 0; }
  .nav-item { padding: 10px; font-size: 14px; }
  .main { padding: 15px; }
  table, .record table { font-size: 11px; min-width: 700px; }
}

/* Print Styles */
@media print { 
    body { background: white; } 
    .sidebar, .btn, .delete-btn, .settings { display: none; } 
    .main { padding: 0; } 
    .summary-container { max-height: none; overflow: visible; } 
}
</style>
</head>
<body>

<div class="sidebar">
  <h2>üì¶ Booking App</h2>
  <div class="nav-item active" data-target="form">New Booking</div>
  <div class="nav-item" data-target="settings">Settings</div>
</div>

<div class="main">
    
<div id="formSection">
    <h1>Booking Form</h1>
    <form id="bookingForm">
        <label>Name of Account (MD/Patient):</label>
        <input type="text" id="name" required>
        
        <label>Contact Number:</label>
        <input type="tel" id="contact" required>
        
        <label>Delivery Option:</label>
        <select id="delivery">
            <option>Pick-Up (by client at office)</option>
            <option>Delivery (by branch rider to client)</option>
            <option selected>Pick-Up by Lalamove / Grab / Courier</option>
        </select>
        
        <label>Pick-Up / Delivery Address:</label>
        <textarea id="address" rows="2"></textarea>
        
        <label>Preferred Date & Time:</label>
        <input type="date" id="date"> <input type="time" id="time">
        
        <label>Payment Option:</label>
        <select id="payment">
            <option value="C.O.D">C.O.D (Cash on Delivery)</option>
            <option value="Terms">Terms</option>
            <option value="PDC">PDC (Post Dated Check)</option>
            <option value="Bank">Deposited thru Bank</option>
        </select>
        
        <div id="termsDaysContainer" style="display:none;">
            <label>Terms (Days):</label>
            <input type="number" id="termsDays" min="1" placeholder="Enter number of days">
        </div>
        <div id="bankContainer" style="display:none;">
            <label>Bank Name:</label>
            <input type="text" id="bankName" placeholder="e.g. BPI, BDO, Metrobank">
        </div>
        
        <label>Order Details:</label>
        <div class="table-responsive">
            <table id="orderTable">
                <thead>
                    <tr>
                        <th>Generic</th>
                        <th>Brand</th>
                        <th>Qty + Unit</th>
                        <th>SRP</th>
                        <th>Discount Type</th>
                        <th>Discount Value</th>
                        <th>Discount Amt</th>
                        <th>No Discount</th>
                        <th>Remarks</th>
                        <th>Total</th>
                        <th>üóë</th>
                    </tr>
                </thead>
                <tbody id="orderBody"></tbody>
            </table>
        </div>
        <button type="button" class="btn" id="addRow">+ Add Item</button>
        
        <label>Total Amount (‚Ç±):</label>
        <input type="number" id="total" readonly>
        
        <label>Distributor & Branch:</label>
        <input type="text" id="distributor">
        
        <label>Remarks / Special Instructions:</label>
        <textarea id="remarks" rows="3"></textarea>
        
        <button class="btn" type="submit">Save Booking</button>
    </form>
</div>

<div class="settings" id="settingsSection" style="display:none; margin-top:20px; text-align:center;">
    <label for="themeSelect">Choose Theme:</label>
    <select id="themeSelect" style="padding:8px; border-radius:8px; width:200px;">
        <option value="default">Blue (Default)</option>
        <option value="black">Black</option>
        <option value="red">Red</option>
        <option value="yellow">Yellow</option>
    </select>
</div>

<div class="summary-container" id="summaryContainer">
    <h3>Saved Bookings</h3>
    <div id="recordList"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
// === ELEMENT REFERENCES ===
const nameInput = document.getElementById('name');
const contactInput = document.getElementById('contact');
const deliveryInput = document.getElementById('delivery');
const addressInput = document.getElementById('address');
const dateInput = document.getElementById('date');
const timeInput = document.getElementById('time');
const distributorInput = document.getElementById('distributor');
const remarksInput = document.getElementById('remarks');

const addRowBtn = document.getElementById('addRow');
const orderBody = document.getElementById('orderBody');
const totalField = document.getElementById('total');
const form = document.getElementById('bookingForm');
const summary = document.getElementById('recordList');
const paymentSelect = document.getElementById('payment');
const termsDaysContainer = document.getElementById('termsDaysContainer');
const bankContainer = document.getElementById('bankContainer');
const termsDaysInput = document.getElementById('termsDays');
const bankNameInput = document.getElementById('bankName');
const navItems = document.querySelectorAll('.nav-item');
const formSection = document.getElementById('formSection');
const settingsSection = document.getElementById('settingsSection');
const summaryContainer = document.getElementById('summaryContainer');
const themeSelect = document.getElementById('themeSelect');

// === PAYMENT TOGGLE ===
paymentSelect.addEventListener('change', () => {
    termsDaysContainer.style.display = paymentSelect.value === 'Terms' ? 'block' : 'none';
    bankContainer.style.display = paymentSelect.value === 'Bank' ? 'block' : 'none';
});

// === ADD ROW ===
function addRow() {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td><input type="text" class="generic"></td>
        <td><input type="text" class="brand"></td>
        <td>
            <input type="number" class="qty" min="1" value="1" style="width:50px;">
            <select class="unit" style="width:70px; margin-top:0;">
                <option value="pcs">Pcs</option>
                <option value="box">Box</option>
                <option value="pfs">Pfs</option>
                <option value="vials">Vials</option>
            </select>
        </td>
        <td><input type="number" class="srp" min="0" value="0"></td>
        <td>
            <select class="discountType">
                <option value="percent">%</option>
                <option value="amount">Fixed Amount</option>
                <option value="nodisc">No Discount</option>
            </select>
        </td>
        <td><input type="number" class="discount" min="0" value="0"></td>
        <td><input type="number" class="discountAmt" readonly></td>
        <td><input type="number" class="nodisc" readonly></td>
        <td><input type="text" class="remarksItem"></td>
        <td><input type="number" class="total" readonly></td>
        <td><button type="button" class="deleteRow">‚ùå</button></td>`;
    orderBody.appendChild(row);
    updateTotals();
}

// === UPDATE TOTALS ===
function updateTotals() {
    let grandTotal = 0;
    document.querySelectorAll('#orderBody tr').forEach(row => {
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const srp = parseFloat(row.querySelector('.srp').value) || 0;
        const discountType = row.querySelector('.discountType').value;
        const discount = parseFloat(row.querySelector('.discount').value) || 0;
        const noDisc = srp * qty;
        let discAmt = 0, total = noDisc;

        if (discountType === 'percent') {
            discAmt = noDisc * discount / 100;
            total = noDisc - discAmt;
        } else if (discountType === 'amount') {
            discAmt = discount;
            total = noDisc - discAmt;
        }

        row.querySelector('.discountAmt').value = discAmt.toFixed(2);
        row.querySelector('.nodisc').value = noDisc.toFixed(2);
        row.querySelector('.total').value = total.toFixed(2);
        grandTotal += total;
    });
    totalField.value = grandTotal.toFixed(2);
}

// Event delegation for order table changes
orderBody.addEventListener('input', e => {
    // Only update when relevant fields change
    if (e.target.closest('tr') && ['qty', 'srp', 'discount', 'discountType'].includes(e.target.className)) {
        updateTotals();
    }
});
orderBody.addEventListener('click', e => {
    if (e.target.classList.contains('deleteRow')) {
        e.target.closest('tr').remove();
        updateTotals();
    }
});
addRowBtn.addEventListener('click', addRow);

// === NAVIGATION & SETTINGS ===
function navigate(target) {
    // Show/Hide sections
    formSection.style.display = target === 'form' ? 'block' : 'none';
    settingsSection.style.display = target === 'settings' ? 'block' : 'none';
    summaryContainer.style.display = target === 'form' ? 'block' : 'none'; // Summary shows with the form

    // Update active class in sidebar
    navItems.forEach(i => i.classList.remove('active'));
    document.querySelector(`.nav-item[data-target="${target}"]`).classList.add('active');
}

navItems.forEach(item => {
    item.addEventListener('click', () => {
        const target = item.getAttribute('data-target');
        navigate(target);
    });
});

themeSelect.addEventListener('change', () => {
    const theme = themeSelect.value;
    const root = document.documentElement.style;

    if (theme === 'default') {
        root.setProperty('--sidebar-color', '#0d6efd');
        root.setProperty('--main-color', '#0d6efd');
        root.setProperty('--btn-color', '#0d6efd');
    } else if (theme === 'black') {
        root.setProperty('--sidebar-color', '#333');
        root.setProperty('--main-color', '#000');
        root.setProperty('--btn-color', '#555');
    } else if (theme === 'red') {
        root.setProperty('--sidebar-color', '#dc3545');
        root.setProperty('--main-color', '#b02a37');
        root.setProperty('--btn-color', '#dc3545');
    } else if (theme === 'yellow') {
        root.setProperty('--sidebar-color', '#ffc107');
        root.setProperty('--main-color', '#e0a800');
        root.setProperty('--btn-color', '#ffc107');
    }
});

// === SAVE BOOKING ===
form.addEventListener('submit', e => {
    e.preventDefault();
    
    // Check if there are any items
    if (orderBody.children.length === 0) {
        alert("Please add at least one item to the order.");
        return;
    }

    // 1. Collect Order Items
    const items = [];
    document.querySelectorAll('#orderBody tr').forEach(row => {
        const qty = parseFloat(row.querySelector('.qty').value) || 0;
        const srp = parseFloat(row.querySelector('.srp').value) || 0;
        const discountType = row.querySelector('.discountType').value;
        const discount = parseFloat(row.querySelector('.discount').value) || 0;
        
        let noDisc = srp * qty, discAmt = 0, total = noDisc;

        if (discountType === 'percent') {
            discAmt = noDisc * discount / 100;
            total = noDisc - discAmt;
        } else if (discountType === 'amount') {
            discAmt = discount;
            total = noDisc - discAmt;
        }

        items.push({
            generic: row.querySelector('.generic').value,
            brand: row.querySelector('.brand').value,
            qty: qty,
            unit: row.querySelector('.unit').value,
            srp: srp,
            discountType: discountType,
            discount: discount,
            discountAmt: discAmt.toFixed(2),
            total: total.toFixed(2),
            remarks: row.querySelector('.remarksItem').value
        });
    });

    // 2. Format Payment Type
    let paymentType = paymentSelect.value;
    if (paymentType === 'Terms') paymentType += ` (${termsDaysInput.value || 'N/A'} days)`;
    if (paymentType === 'Bank') paymentType += ` - ${bankNameInput.value || 'N/A'}`;

    // 3. Create Record Object
    const record = {
        name: nameInput.value,
        contact: contactInput.value,
        delivery: deliveryInput.value,
        address: addressInput.value,
        date: dateInput.value,
        time: timeInput.value,
        payment: paymentType,
        distributor: distributorInput.value,
        remarks: remarksInput.value,
        total: totalField.value,
        items
    };

    // 4. Save to Local Storage
    const records = JSON.parse(localStorage.getItem('bookings')) || [];
    records.push(record);
    localStorage.setItem('bookings', JSON.stringify(records));

    // 5. Reset and Refresh
    loadRecords();
    form.reset();
    orderBody.innerHTML = '';
    totalField.value = '';
    termsDaysContainer.style.display = 'none';
    bankContainer.style.display = 'none';
    alert("Booking saved successfully!");
});

// === LOAD RECORDS ===
function loadRecords() {
    const records = JSON.parse(localStorage.getItem('bookings')) || [];
    summary.innerHTML = '';
    
    // Make deleteRecord and downloadPDF available globally for inline onclick
    window.deleteRecord = deleteRecord;
    window.downloadPDF = downloadPDF;

    records.forEach((rec, index) => {
        const div = document.createElement('div');
        div.classList.add('record');
        div.innerHTML = `
            <h4>${rec.name} - ‚Ç±${rec.total}</h4>
            üìû ${rec.contact}<br>
            üöö ${rec.delivery}<br>
            üí≥ ${rec.payment}<br>
            üè¢ ${rec.distributor}<br>
            üìç ${rec.address || 'N/A'}<br>
            <p>Remarks: ${rec.remarks || 'None'}</p>
            <button class="delete-btn" onclick="deleteRecord(${index})">Delete</button>
            <button class="btn" style="width:auto; margin-top:5px; padding: 5px 10px; font-size:14px;" onclick="downloadPDF(${index})">üìÑ Export PDF</button>
            <details style="margin-top:10px;"><summary style="font-weight:600;">View Details</summary>
            <div class="table-responsive">
                <table>
                    <thead><tr>
                        <th>Generic</th><th>Brand</th><th>Qty</th><th>Unit</th><th>SRP</th><th>Disc Type</th><th>Disc Value</th><th>Disc Amt</th><th>Total</th><th>Remarks</th></tr></thead>
                    <tbody>
                    ${rec.items.map(item => `<tr>
                        <td>${item.generic}</td>
                        <td>${item.brand}</td>
                        <td>${item.qty}</td>
                        <td>${item.unit}</td>
                        <td>${item.srp}</td>
                        <td>${item.discountType}</td>
                        <td>${item.discount}</td>
                        <td>${item.discountAmt}</td>
                        <td>${item.total}</td>
                        <td>${item.remarks}</td>
                    </tr>`).join('')}
                    </tbody>
                </table>
            </div>
            </details>`;
        summary.appendChild(div);
    });
}

// === DELETE RECORD ===
function deleteRecord(index) {
    if (!confirm("Are you sure you want to delete this booking?")) return;
    const records = JSON.parse(localStorage.getItem('bookings')) || [];
    records.splice(index, 1);
    localStorage.setItem('bookings', JSON.stringify(records));
    loadRecords();
}

// === DOWNLOAD PDF PER TRANSACTION (REVISED FOR DATA INTEGRITY AND FIT) ===
function downloadPDF(index) {
    const records = JSON.parse(localStorage.getItem('bookings')) || [];
    const rec = records[index];
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;

    // --- 1. Title ---
    doc.setFontSize(18);
    doc.setTextColor(20, 20, 20);
    doc.text(`üì¶ BOOKING RECEIPT / SUMMARY`, 105, y, null, null, "center"); y += 10;
    
    // --- 2. Booking Info Table (Header Details) ---
    doc.setFontSize(10);
    doc.setTextColor(50, 50, 50);

    const bookingInfoData = [
        ['Account Name (MD/Patient):', rec.name],
        ['Contact No.:', rec.contact],
        ['Date & Time:', `${rec.date || 'N/A'} ${rec.time || 'N/A'}`], // Added N/A check
        ['Distributor & Branch:', rec.distributor || 'N/A'], // Added N/A check
        ['Delivery Option:', rec.delivery],
        ['Payment Option:', rec.payment],
        ['Pick-Up / Delivery Address:', rec.address || 'N/A'],
        ['Remarks / Instructions:', rec.remarks || 'None'],
    ];

    doc.autoTable({
        head: [['Booking Information']],
        body: bookingInfoData,
        startY: y,
        theme: 'striped',
        styles: { fontSize: 9, cellPadding: 2, overflow: 'linebreak' },
        headStyles: { fillColor: [13, 110, 253], textColor: 255, fontStyle: 'bold', fontSize: 11 },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 50 }, // Label column
            1: { cellWidth: 'auto' } // Value column - set to auto to fill remaining width
        },
        margin: { top: 10, left: 10, right: 10, bottom: 10 },
    });
    
    y = doc.lastAutoTable.finalY + 10;
    
    // --- 3. Order Details Table ---
    doc.setFontSize(10);
    doc.text(`ORDER DETAILS`, 10, y); y += 5;

    // Data verification for items table
    const orderData = rec.items.map(item => [
        item.generic || '',
        item.brand || '',
        `${item.qty || '0'} ${item.unit || ''}`,
        item.srp || '0',
        item.discountType === 'percent' ? `${item.discount || '0'}%` : 'Fixed Amt',
        item.discountAmt || '0.00',
        item.total || '0.00',
        item.remarks || ''
    ]);
    
    doc.autoTable({
        head: [['Generic', 'Brand', 'Qty/Unit', 'SRP (‚Ç±)', 'Disc Type', 'Disc Amt (‚Ç±)', 'Subtotal (‚Ç±)', 'Remarks']],
        body: orderData,
        startY: y,
        styles: { fontSize: 8.5, cellPadding: 1, overflow: 'linebreak' }, // Smaller font size and padding
        headStyles: { fillColor: [13, 110, 253], textColor: 255, fontStyle: 'bold' },
        foot: [['', '', '', '', '', 'GRAND TOTAL (‚Ç±)', rec.total, '']],
        footStyles: { fillColor: [200, 220, 255], textColor: 0, fontStyle: 'bold', fontSize: 10, halign: 'right' },
        columnStyles: {
            // Setting custom widths/alignment for better fit
            0: { cellWidth: 25 }, // Generic
            1: { cellWidth: 25 }, // Brand
            2: { cellWidth: 20 }, // Qty/Unit
            3: { cellWidth: 15, halign: 'right' }, // SRP
            4: { cellWidth: 15 }, // Disc Type
            5: { cellWidth: 18, halign: 'right' }, // Disc Amt
            6: { cellWidth: 18, halign: 'right' }, // Subtotal
            7: { cellWidth: 'auto' } // Remarks (takes remaining space)
        },
        margin: { top: 10, left: 10, right: 10, bottom: 10 },
    });

    doc.save(`Booking_${rec.name}_${rec.date}.pdf`);
}

// Initial load
loadRecords();

</script>
</div>
</body>
</html>
