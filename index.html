<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üì¶ Booking App</title>

<!-- SheetJS for Excel Export -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<!-- html2canvas for JPEG Export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
/* --- GENERAL STYLES --- */
* { box-sizing: border-box; font-family: 'Poppins', sans-serif; }
body { margin: 0; display: flex; min-height: 100vh; background: #f4f6f9; }

/* --- SIDEBAR --- */
.sidebar {
  width: 230px; background: var(--sidebar-color, #0d6efd); color: white;
  display: flex; flex-direction: column; align-items: center; padding: 20px 0;
}
.sidebar h2 { font-size: 20px; margin-bottom: 40px; }
.nav-item {
  width: 100%; text-align: center; padding: 12px 0; cursor: pointer; transition: 0.2s;
}
.nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.15); }

/* --- MAIN --- */
.main { flex: 1; padding: 30px; overflow-y: auto; }
h1 { color: var(--main-color, #0d6efd); text-align: center; margin-bottom: 20px; }
form {
  background: #fff; padding: 20px; border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 900px; margin: auto;
}
label { font-weight: 600; margin-top: 10px; display: block; }
input, textarea, select {
  width: 100%; padding: 8px; margin-top: 6px;
  border: 1px solid #ccc; border-radius: 8px; font-size: 14px;
}
input:focus, textarea:focus, select:focus { border-color: var(--main-color, #0d6efd); outline: none; }

textarea { resize: vertical; }

/* --- BUTTONS --- */
.btn {
  background: var(--btn-color, #0d6efd); color: white; border: none;
  border-radius: 8px; padding: 10px; font-size: 16px; cursor: pointer;
  margin-top: 15px; transition: 0.2s;
}
.btn:hover { opacity: 0.9; }

.btn-delete {
  background: #dc3545; color: white; border: none; padding: 8px 14px;
  border-radius: 8px; cursor: pointer; transition: 0.2s;
}
.btn-delete:hover { background: #b02a37; }

.table-responsive { overflow-x: auto; width: 100%; margin-top: 10px; }
table { width: 100%; min-width: 900px; border-collapse: collapse; table-layout: fixed; }
th, td {
  border: 1px solid #ddd; padding: 6px; font-size: 13px; text-align: center;
  vertical-align: top; white-space: normal; word-wrap: break-word; overflow-wrap: break-word;
}
th { background: var(--main-color, #0d6efd); color: white; }

/* Limit width of Remarks columns so they wrap vertically */
td:nth-child(9), th:nth-child(9),
td:nth-child(10), th:nth-child(10) { max-width: 200px; }

/* --- RECORDS LIST --- */
.summary-container {
  background: #fff; padding: 15px; border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 20px;
}
.record { border: 1px solid #ddd; border-radius: 8px; padding: 10px 12px; margin-bottom: 12px; background: #fafbff; }
.record h4 { margin: 0 0 5px; color: var(--main-color, #0d6efd); }
.record table th, .record table td { border: 1px solid #ddd; font-size: 12px; padding: 4px; }

/* --- RESPONSIVE --- */
@media (max-width: 768px) {
  body { flex-direction: column; height: auto; }
  .sidebar { width: 100%; flex-direction: row; justify-content: space-around; padding: 10px 0; }
  .sidebar h2 { font-size: 18px; margin: 0; }
  .nav-item { padding: 10px; font-size: 14px; }
  table, .record table { font-size: 11px; min-width: 700px; }
}
</style>
</head>
<body>

<div class="sidebar">
  <h2>üì¶ Booking App</h2>
  <div class="nav-item active">New Booking</div>
  <div class="nav-item">Settings</div>
</div>

<div class="main">
<h1>Booking Form</h1>
<form id="bookingForm">
  <label>Name of Account (MD/Patient):</label>
  <input type="text" id="name" required>
  
  <label>Contact Number:</label>
  <input type="tel" id="contact" required>
  
  <label>Delivery Option:</label>
  <select id="delivery">
    <option>Pick-Up (by client at office)</option>
    <option>Delivery (by MANILA branch rider to hub (CSP)</option>
    <option selected>Pick-Up by Lalamove / Grab / Courier</option>
  </select>
  
  <label>Pick-Up / Delivery Address:</label>
  <textarea id="address" rows="2"></textarea>
  
  <label>Preferred Date & Time:</label>
  <input type="date" id="date"> <input type="time" id="time">
  
  <label>Payment Option:</label>
  <select id="payment">
    <option value="C.O.D">C.O.D (Cash on Delivery)</option>
    <option value="Terms">Terms</option>
    <option value="PDC">PDC (Post Dated Check)</option>
    <option value="Bank">Deposited thru Bank</option>
  </select>
  
  <div id="termsDaysContainer" style="display:none;">
    <label>Terms (Days):</label>
    <input type="number" id="termsDays" min="1" placeholder="Enter number of days">
  </div>
  
  <div id="bankContainer" style="display:none;">
    <label>Bank Name:</label>
    <input type="text" id="bankName" placeholder="e.g. BPI, BDO, Metrobank">
  </div>
  
  <label>Order Details:</label>
  <div class="table-responsive">
    <table id="orderTable">
      <thead>
        <tr>
          <th>Generic</th><th>Brand</th><th>Qty + Unit</th><th>SRP</th>
          <th>Discount Type</th><th>Discount Value</th><th>Discount Amt</th>
          <th>No Discount</th><th>Remarks</th><th>Total</th><th>üóë</th>
        </tr>
      </thead>
      <tbody id="orderBody"></tbody>
    </table>
  </div>
  <button type="button" class="btn" id="addRow">+ Add Item</button>
  
  <label>Total Amount (‚Ç±):</label>
  <input type="number" id="total" readonly step="0.01">
  
  <label>Distributor & Branch:</label>
  <input type="text" id="distributor">
  
  <label>Remarks / Special Instructions:</label>
  <textarea id="remarks" rows="3"></textarea>
  
  <button class="btn" type="submit">Save Booking</button>
</form>

<div class="settings" style="display:none; margin-top:20px; text-align:center;">
  <label for="themeSelect" style="color:white;">Choose Theme:</label>
  <select id="themeSelect" style="padding:5px; border-radius:5px;">
    <option value="default">Blue (Default)</option>
    <option value="black">Black</option>
    <option value="red">Red</option>
    <option value="yellow">Yellow</option>
  </select>
</div>

<div class="summary-container" id="summaryContainer">
  <h3>Saved Bookings</h3>
  <div id="recordList"></div>
</div>

<script>
// === ELEMENTS ===
const nameInput = document.getElementById('name');
const contactInput = document.getElementById('contact');
const deliveryInput = document.getElementById('delivery');
const addressInput = document.getElementById('address');
const dateInput = document.getElementById('date');
const timeInput = document.getElementById('time');
const distributorInput = document.getElementById('distributor');
const remarksInput = document.getElementById('remarks');
const addRowBtn = document.getElementById('addRow');
const orderBody = document.getElementById('orderBody');
const totalField = document.getElementById('total');
const form = document.getElementById('bookingForm');
const summary = document.getElementById('recordList');
const paymentSelect = document.getElementById('payment');
const termsDaysContainer = document.getElementById('termsDaysContainer');
const bankContainer = document.getElementById('bankContainer');
const termsDaysInput = document.getElementById('termsDays');
const bankNameInput = document.getElementById('bankName');
const navItems = document.querySelectorAll('.nav-item');
const settingsDiv = document.querySelector('.settings');
const themeSelect = document.getElementById('themeSelect');

// === PAYMENT TOGGLE ===
paymentSelect.addEventListener('change', () => {
  termsDaysContainer.style.display = paymentSelect.value === 'Terms' ? 'block' : 'none';
  bankContainer.style.display = paymentSelect.value === 'Bank' ? 'block' : 'none';
});

// === ADD ROW ===
function addRow() {
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" class="generic"></td>
    <td><input type="text" class="brand"></td>
    <td>
      <input type="number" class="qty" min="0" value="1" step="0.01" style="width:60px;">
      <select class="unit" style="width:70px;">
        <option value="pcs">Pcs</option>
        <option value="box">Box</option>
        <option value="pfs">Pfs</option>
        <option value="vial">Vials</option>
      </select>
    </td>
    <td><input type="number" class="srp" min="0" value="0" step="0.01"></td>
    <td>
      <select class="discountType">
        <option value="percent">%</option>
        <option value="amount">Fixed Amount</option>
        <option value="nodisc">No Discount</option>
      </select>
    </td>
    <td><input type="number" class="discount" min="0" value="0" step="0.01"></td>
    <td><input type="number" class="discountAmt" readonly></td>
    <td><input type="number" class="nodisc" readonly></td>
    <td><input type="text" class="remarksItem"></td>
    <td><input type="number" class="total" readonly></td>
    <td><button type="button" class="deleteRow">‚ùå</button></td>`;
  orderBody.appendChild(row);
  updateTotals();
}

// === UPDATE TOTALS ===
function updateTotals() {
  let grandTotal = 0;
  document.querySelectorAll('#orderBody tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.qty').value) || 0;
    const srp = parseFloat(row.querySelector('.srp').value) || 0;
    const discountType = row.querySelector('.discountType').value;
    const discount = parseFloat(row.querySelector('.discount').value) || 0;

    const noDisc = srp * qty;
    let discAmt = 0, total = noDisc;

    if (discountType === 'percent') discAmt = noDisc * discount / 100;
    else if (discountType === 'amount') discAmt = discount;

    total = noDisc - discAmt;
    row.querySelector('.discountAmt').value = discAmt.toFixed(2);
    row.querySelector('.nodisc').value = noDisc.toFixed(2);
    row.querySelector('.total').value = total.toFixed(2);

    grandTotal += total;
  });
  totalField.value = grandTotal.toFixed(2);
}

// === EVENT LISTENERS ===
orderBody.addEventListener('input', e => {
  if (['qty','srp','discount','discountType'].includes(e.target.className)) updateTotals();
});

orderBody.addEventListener('click', e => {
  if (e.target.classList.contains('deleteRow')) {
    e.target.closest('tr').remove();
    updateTotals();
  }
});

addRowBtn.addEventListener('click', addRow);

// --- NAVIGATION & THEME ---
navItems.forEach(item => {
  item.addEventListener('click', () => {
    navItems.forEach(i => i.classList.remove('active'));
    item.classList.add('active');
    settingsDiv.style.display = item.textContent.trim() === 'Settings' ? 'block' : 'none';
  });
});

themeSelect.addEventListener('change', () => {
  const theme = themeSelect.value;
  const themes = {
    default: ['#0d6efd','#0d6efd','#0d6efd'],
    black: ['#333','#000','#555'],
    red: ['#dc3545','#b02a37','#dc3545'],
    yellow: ['#ffc107','#e0a800','#ffc107']
  };
  [ '--sidebar-color', '--main-color', '--btn-color' ].forEach((varName,i) => {
    document.documentElement.style.setProperty(varName, themes[theme][i]);
  });
});

// --- SAVE BOOKING ---
form.addEventListener('submit', e => {
  e.preventDefault();
  const items = [];
  document.querySelectorAll('#orderBody tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.qty').value) || 0;
    const srp = parseFloat(row.querySelector('.srp').value) || 0;
    const discountType = row.querySelector('.discountType').value;
    const discount = parseFloat(row.querySelector('.discount').value) || 0;
    const noDisc = srp * qty;
    let discAmt = 0, total = noDisc;
    if (discountType === 'percent') discAmt = noDisc * discount / 100;
    else if (discountType === 'amount') discAmt = discount;
    total = noDisc - discAmt;

    items.push({
      generic: row.querySelector('.generic').value,
      brand: row.querySelector('.brand').value,
      qty, unit: row.querySelector('.unit').value, srp,
      discountType, discount,
      discountAmt: discAmt.toFixed(2),
      total: total.toFixed(2),
      remarks: row.querySelector('.remarksItem').value
    });
  });

  let paymentType = paymentSelect.value;
  if (paymentType === 'Terms') paymentType += ` (${termsDaysInput.value} days)`;
  if (paymentType === 'Bank') paymentType += ` - ${bankNameInput.value}`;

  const now = new Date().toLocaleString();

  const record = {
    name: nameInput.value, contact: contactInput.value,
    delivery: deliveryInput.value, address: addressInput.value,
    date: dateInput.value, time: timeInput.value,
    payment: paymentType, distributor: distributorInput.value,
    remarks: remarksInput.value, total: totalField.value,
    items, details: JSON.stringify(items, null, 2),
    createdAt: now // <-- timestamp added
  };

  const records = JSON.parse(localStorage.getItem('bookings')) || [];
  records.push(record);
  localStorage.setItem('bookings', JSON.stringify(records));
  loadRecords();
  form.reset();
  orderBody.innerHTML = '';
  totalField.value = '';
  termsDaysContainer.style.display = 'none';
  bankContainer.style.display = 'none';
});

// --- LOAD RECORDS ---
function loadRecords() {
  const records = JSON.parse(localStorage.getItem('bookings')) || [];
  summary.innerHTML = '';
  records.forEach((rec,index) => {
    const div = document.createElement('div');
    div.classList.add('record');
    div.innerHTML = `
      <h4>${rec.name} - ‚Ç±${rec.total}</h4>
      üìû ${rec.contact}<br>
      üöö ${rec.delivery}<br>
      üí≥ ${rec.payment}<br>
      üè¢ ${rec.distributor}<br>
      üìç ${rec.address || 'N/A'}<br>
      üïí Created: ${rec.createdAt || 'N/A'}<br>
      <p>Remarks: ${rec.remarks || 'None'}</p>
      <button class="delete-btn" onclick="deleteRecord(${index})">Delete</button>
      <button class="btn" style="margin-top:5px;" onclick="downloadExcel(${index})">üìÑ Export Excel</button>
      <button class="btn" style="margin-top:5px;" onclick="downloadJPEG(${index})">üñº Export JPEG</button>
      <details style="margin-top:8px;"><summary>View Details</summary>
      <table>
        <thead><tr>
          <th>Generic</th><th>Brand</th><th>Qty</th><th>Unit</th>
          <th>SRP</th><th>Discount Type</th><th>Discount Value</th>
          <th>Discount Amt</th><th>Total</th><th>Remarks</th>
        </tr></thead>
        <tbody>
          ${rec.items.map(item => `
            <tr>
              <td>${item.generic}</td>
              <td>${item.brand}</td>
              <td>${item.qty}</td>
              <td>${item.unit}</td>
              <td>${item.srp}</td>
              <td>${item.discountType}</td>
              <td>${item.discount}</td>
              <td>${item.discountAmt}</td>
              <td>${item.total}</td>
              <td>${item.remarks}</td>
            </tr>`).join('')}
        </tbody>
      </table></details>`;
    summary.appendChild(div);
  });
}

// --- DELETE RECORD ---
function deleteRecord(index) {
  const records = JSON.parse(localStorage.getItem('bookings')) || [];
  records.splice(index, 1);
  localStorage.setItem('bookings', JSON.stringify(records));
  loadRecords();
}

// --- EXPORT EXCEL ---
function downloadExcel(index) {
  const records = JSON.parse(localStorage.getItem('bookings')) || [];
  const rec = records[index];

  // --- Prepare worksheet data ---
  const wsData = [
    ['Booking for', rec.name],
    ['Contact', rec.contact],
    ['Delivery', rec.delivery],
    ['Address', rec.address || 'N/A'],
    ['Date & Time', `${rec.date} ${rec.time}`],
    ['Payment', rec.payment],
    ['Distributor', rec.distributor],
    ['Remarks', rec.remarks || 'None'],
    ['Created At', rec.createdAt || 'N/A'],
    [],
    ['Generic','Brand','Qty','Unit','SRP','Discount Type','Discount Value','Discount Amt','Total','Remarks']
  ];

  rec.items.forEach(item => {
    wsData.push([
      item.generic, item.brand, item.qty, item.unit, item.srp,
      item.discountType, item.discount, item.discountAmt, item.total, item.remarks
    ]);
  });

  // Add total in the last column of the table
  const lastRowIndex = wsData.length;
  wsData.push(['','','','','','','','','Total Amount', rec.total]);

  // --- Create workbook and worksheet ---
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(wsData);

  // --- Auto-width columns ---
  const colWidths = wsData[10].map((_, i) => {
    return { wch: Math.max(...wsData.map(r => (r[i] ? r[i].toString().length : 0))) + 2 };
  });
  ws['!cols'] = colWidths;

  XLSX.utils.book_append_sheet(wb, ws, 'Booking');

  // --- Export Excel ---
  // sanitize filename
  const safeName = (rec.name || 'Booking').replace(/[\\/:*?"<>|]/g, '_');
  XLSX.writeFile(wb, `Booking_${safeName}_${rec.date || ''}.xlsx`);
}

// --- EXPORT JPEG ---
function downloadJPEG(index) {
  const records = JSON.parse(localStorage.getItem('bookings')) || [];
  const rec = records[index];

  const tempDiv = document.createElement('div');
  tempDiv.style.padding = '20px';
  tempDiv.style.background = '#fff';
  tempDiv.style.width = '1000px';
  tempDiv.style.fontFamily = 'Poppins, sans-serif';
  tempDiv.style.fontSize = '13px';
  tempDiv.innerHTML = `
    <h2 style="color:#0d6efd; text-align:center;">üì¶ Booking Summary</h2>
    <p><b>Booking for:</b> ${rec.name}</p>
    <p><b>Contact:</b> ${rec.contact}</p>
    <p><b>Delivery:</b> ${rec.delivery}</p>
    <p><b>Address:</b> ${rec.address || 'N/A'}</p>
    <p><b>Date & Time:</b> ${rec.date} ${rec.time}</p>
    <p><b>Payment:</b> ${rec.payment}</p>
    <p><b>Distributor:</b> ${rec.distributor}</p>
    <p><b>Remarks / Special Instructions:</b> ${rec.remarks || 'None'}</p>
    <p><b>Created At:</b> ${rec.createdAt || 'N/A'}</p>
    <br>
    <table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse; text-align:center; table-layout:fixed;">
      <thead style="background:#0d6efd; color:#fff;">
        <tr>
          <th>Generic</th>
          <th>Brand</th>
          <th>Qty</th>
          <th>Unit</th>
          <th>SRP</th>
          <th>Discount Type</th>
          <th>Discount Value</th>
          <th>Discount Amt</th>
          <th>Total</th>
          <th style="max-width:200px; word-wrap:break-word;">Remarks</th>
        </tr>
      </thead>
      <tbody>
        ${rec.items.map(item => `
          <tr>
            <td>${item.generic}</td>
            <td>${item.brand}</td>
            <td>${item.qty}</td>
            <td>${item.unit}</td>
            <td>${item.srp}</td>
            <td>${item.discountType}</td>
            <td>${item.discount}</td>
            <td>${item.discountAmt}</td>
            <td>${item.total}</td>
            <td style="white-space:normal; word-wrap:break-word; max-width:200px;">${item.remarks}</td>
          </tr>
        `).join('')}
        <tr>
          <td colspan="8" style="text-align:right; font-weight:bold;">Total Amount</td>
          <td colspan="2" style="font-weight:bold;">‚Ç±${rec.total}</td>
        </tr>
      </tbody>
    </table>
  `;

  document.body.appendChild(tempDiv);

  html2canvas(tempDiv, {
    scale: 3,
    backgroundColor: '#ffffff',
    useCORS: true
  }).then(canvas => {
    const link = document.createElement('a');
    const safeName = (rec.name || 'Booking').replace(/[\\/:*?"<>|]/g, '_');
    link.download = `Booking_${safeName}_${rec.date || ''}.jpeg`;
    link.href = canvas.toDataURL('image/jpeg', 1.0);
    link.click();
    document.body.removeChild(tempDiv);
  });
}

// --- INITIAL LOAD ---
loadRecords();
</script>
</div>
</body>
</html>
